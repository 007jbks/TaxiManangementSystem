<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>Book a Taxi</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            @import url("https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap");

            * {
                font-family: "Inter", sans-serif;
            }

            .gradient-bg {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            }

            .card-hover {
                transition: all 0.3s ease;
            }

            .card-hover:hover {
                transform: translateY(-2px);
                box-shadow:
                    0 20px 25px -5px rgba(0, 0, 0, 0.1),
                    0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }

            .input-focus {
                transition: all 0.2s ease;
            }

            .input-focus:focus {
                transform: scale(1.01);
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }

            .btn-gradient {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transition: all 0.3s ease;
            }

            .btn-gradient:hover {
                transform: translateY(-2px);
                box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
            }

            .modal-backdrop {
                backdrop-filter: blur(8px);
            }

            @keyframes slideIn {
                from {
                    opacity: 0;
                    transform: translateY(20px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }

            .animate-slide-in {
                animation: slideIn 0.4s ease-out;
            }
        </style>
    </head>

    <body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
        <!-- NAVBAR -->
        <nav class="gradient-bg p-4 text-white shadow-xl">
            <div
                class="max-w-6xl mx-auto flex flex-col sm:flex-row sm:justify-between gap-3 sm:gap-0 items-center"
            >
                <div class="flex items-center gap-3">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <svg
                            class="w-6 h-6"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"
                            />
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold">Taxi Management</h1>
                </div>
                <button
                    id="logoutBtn"
                    class="bg-white/20 backdrop-blur-sm px-5 py-2 rounded-lg hover:bg-white/30 transition-all w-full sm:w-auto font-medium"
                >
                    Logout
                </button>
            </div>
        </nav>

        <!-- MAIN CONTENT WRAPPER -->
        <div class="max-w-5xl mx-auto mt-8 px-4 sm:px-6 lg:px-8 pb-12">
            <!-- USER INFO -->
            <div
                class="bg-white p-6 rounded-2xl shadow-lg mb-6 card-hover animate-slide-in border border-gray-100"
            >
                <div class="flex items-center gap-3 mb-2">
                    <div
                        class="bg-gradient-to-r from-purple-400 to-indigo-500 p-2 rounded-lg"
                    >
                        <svg
                            class="w-5 h-5 text-white"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
                            />
                        </svg>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                        Welcome Back
                    </h2>
                </div>
                <p
                    id="userInfo"
                    class="text-gray-600 text-sm sm:text-base ml-12"
                >
                    Loading user info...
                </p>
            </div>

            <!-- BOOKING FORM -->
            <div
                class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg mb-6 card-hover animate-slide-in border border-gray-100"
                style="animation-delay: 0.1s"
            >
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="bg-gradient-to-r from-blue-400 to-indigo-500 p-2 rounded-lg"
                    >
                        <svg
                            class="w-5 h-5 text-white"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 4v16m8-8H4"
                            />
                        </svg>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                        Create a Booking
                    </h2>
                </div>

                <form id="bookingForm" class="space-y-5">
                    <div>
                        <label
                            class="block text-sm font-semibold text-gray-700 mb-2"
                            >Pickup Location</label
                        >
                        <input
                            id="source"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-sm sm:text-base input-focus outline-none bg-gray-50"
                            placeholder="Enter pickup location"
                            required
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-semibold text-gray-700 mb-2"
                            >Dropoff Location</label
                        >
                        <input
                            id="destination"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-sm sm:text-base input-focus outline-none bg-gray-50"
                            placeholder="Enter dropoff location"
                            required
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-semibold text-gray-700 mb-2"
                            >Distance (km)</label
                        >
                        <input
                            type="number"
                            id="distance"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-sm sm:text-base input-focus outline-none bg-gray-50"
                            placeholder="Enter distance in kilometers"
                            required
                        />
                    </div>

                    <div>
                        <label
                            class="block text-sm font-semibold text-gray-700 mb-2"
                            >Select Taxi</label
                        >
                        <select
                            id="taxiSelect"
                            class="w-full p-3 border-2 border-gray-200 rounded-xl text-sm sm:text-base input-focus outline-none bg-gray-50 cursor-pointer"
                        ></select>
                    </div>

                    <button
                        class="btn-gradient text-white px-6 py-3 rounded-xl w-full text-sm sm:text-base font-semibold shadow-lg"
                    >
                        Book Taxi Now
                    </button>
                </form>
            </div>

            <!-- BOOKINGS LIST -->
            <div
                class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg card-hover animate-slide-in border border-gray-100"
                style="animation-delay: 0.2s"
            >
                <div class="flex items-center gap-3 mb-6">
                    <div
                        class="bg-gradient-to-r from-green-400 to-teal-500 p-2 rounded-lg"
                    >
                        <svg
                            class="w-5 h-5 text-white"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"
                            />
                        </svg>
                    </div>
                    <h2 class="text-xl sm:text-2xl font-bold text-gray-800">
                        Your Bookings
                    </h2>
                </div>
                <div
                    id="bookingList"
                    class="space-y-4 text-gray-700 text-sm sm:text-base"
                >
                    Loading bookings...
                </div>
            </div>
        </div>

        <!-- RECEIPT POPUP -->
        <div
            id="ticketModal"
            class="fixed inset-0 bg-black/50 modal-backdrop hidden items-center justify-center p-4 z-50"
        >
            <div
                class="bg-white w-full max-w-sm sm:max-w-md rounded-2xl p-8 shadow-2xl transform transition-all animate-slide-in"
            >
                <div class="text-center mb-6">
                    <div
                        class="bg-gradient-to-r from-green-400 to-teal-500 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"
                    >
                        <svg
                            class="w-8 h-8 text-white"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M5 13l4 4L19 7"
                            />
                        </svg>
                    </div>
                    <h2 class="text-2xl font-bold text-gray-800">
                        Booking Confirmed!
                    </h2>
                    <p class="text-gray-500 text-sm mt-1">
                        Your taxi is on the way
                    </p>
                </div>

                <div
                    id="ticketContent"
                    class="space-y-3 text-gray-700 text-sm sm:text-base bg-gray-50 p-5 rounded-xl"
                ></div>

                <div class="flex flex-col sm:flex-row justify-end gap-3 mt-6">
                    <button
                        onclick="printTicket()"
                        class="btn-gradient text-white px-6 py-2.5 rounded-xl font-medium shadow-lg w-full sm:w-auto"
                    >
                        Print Receipt
                    </button>

                    <button
                        onclick="closeTicket()"
                        class="bg-gray-200 text-gray-700 px-6 py-2.5 rounded-xl hover:bg-gray-300 transition-all font-medium w-full sm:w-auto"
                    >
                        Close
                    </button>
                </div>
            </div>
        </div>

        <!-- SCRIPT -->
        <script>
            const API = "http://localhost:8000";
            const token = localStorage.getItem("token");

            // LOGOUT
            document
                .getElementById("logoutBtn")
                .addEventListener("click", () => {
                    localStorage.removeItem("token");
                    window.location.href = "login.html";
                });

            async function loadUser() {
                const res = await fetch(`${API}/auth/me`, {
                    headers: { token },
                });
                if (!res.ok) {
                    document.getElementById("userInfo").innerText =
                        "Invalid session";
                    return;
                }
                const user = await res.json();
                document.getElementById("userInfo").innerHTML =
                    `User: <b>${user.name}</b> (ID: ${user.customer_id})`;
                window.USER_ID = user.customer_id;
            }

            async function loadTaxis() {
                const res = await fetch(`${API}/taxi/all`);
                const taxis = await res.json();

                const select = document.getElementById("taxiSelect");
                select.innerHTML = "";
                taxis.forEach((t) => {
                    const opt = document.createElement("option");
                    opt.value = t.taxi_id;
                    opt.textContent = `${t.model} (Cap: ${t.capacity})`;
                    select.appendChild(opt);
                });
            }

            async function loadBookings() {
                const res = await fetch(`${API}/booking/user/me`, {
                    headers: { token },
                });
                const bookings = await res.json();
                const container = document.getElementById("bookingList");

                if (!bookings.length) {
                    container.innerHTML =
                        '<p class="text-gray-500 text-center py-8">No bookings found.</p>';
                    return;
                }

                container.innerHTML = bookings
                    .map(
                        (b) => `
                        <div class="p-5 bg-gradient-to-r from-gray-50 to-gray-100 rounded-xl border-l-4 border-indigo-500 hover:shadow-md transition-all">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                                <p class="text-gray-600"><span class="font-semibold text-gray-800">Booking ID:</span> ${b.booking_id}</p>
                                <p class="text-gray-600"><span class="font-semibold text-gray-800">Status:</span> <span class="inline-block px-3 py-1 rounded-full text-xs font-medium ${b.payment_status === "paid" ? "bg-green-100 text-green-700" : "bg-yellow-100 text-yellow-700"}">${b.payment_status}</span></p>
                                <p class="text-gray-600"><span class="font-semibold text-gray-800">From:</span> ${b.source}</p>
                                <p class="text-gray-600"><span class="font-semibold text-gray-800">To:</span> ${b.destination}</p>
                                <p class="text-gray-600"><span class="font-semibold text-gray-800">Fare:</span> <span class="text-lg font-bold text-indigo-600">₹${b.fare}</span></p>
                            </div>
                        </div>
                    `,
                    )
                    .join("");
            }

            // BOOKING CREATION
            document
                .getElementById("bookingForm")
                .addEventListener("submit", async (e) => {
                    e.preventDefault();

                    const pickup = document
                        .getElementById("source")
                        .value.trim();
                    const drop = document
                        .getElementById("destination")
                        .value.trim();
                    const distance = Number(
                        document.getElementById("distance").value,
                    );

                    if (pickup.toLowerCase() === drop.toLowerCase()) {
                        alert("Pickup and Dropoff cannot be the same.");
                        return;
                    }

                    if (distance > 200) {
                        alert("Max allowed distance is 200 km.");
                        return;
                    }

                    const payload = {
                        taxi_id: document.getElementById("taxiSelect").value,
                        source: pickup,
                        destination: drop,
                        distance_km: distance,
                    };

                    const res = await fetch(`${API}/booking/create`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json", token },
                        body: JSON.stringify(payload),
                    });

                    const data = await res.json();
                    showTicketPopup(data);
                    loadBookings();
                });

            function showTicketPopup(data) {
                document.getElementById("ticketContent").innerHTML = `
                    <p class="flex justify-between"><span class="font-semibold">Fare:</span> <span class="text-lg font-bold text-indigo-600">₹${data.fare}</span></p>
                    <p class="flex justify-between"><span class="font-semibold">Driver Name:</span> <span>${data.driver_name}</span></p>
                    <p class="flex justify-between"><span class="font-semibold">Driver Phone:</span> <span>${data.driver_phone}</span></p>
                    <p class="flex justify-between"><span class="font-semibold">Date:</span> <span>${new Date().toLocaleString()}</span></p>
                `;
                document
                    .getElementById("ticketModal")
                    .classList.remove("hidden");
                document.getElementById("ticketModal").classList.add("flex");
            }

            function closeTicket() {
                document.getElementById("ticketModal").classList.add("hidden");
            }

            function printTicket() {
                const content =
                    document.getElementById("ticketContent").innerHTML;
                const printWindow = window.open("", "", "width=600,height=400");
                printWindow.document.write(content);
                printWindow.print();
                printWindow.close();
            }

            (async () => {
                await loadUser();
                await loadTaxis();
                await loadBookings();
            })();
        </script>
    </body>
</html>
